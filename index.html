<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>Mini Music - Lite</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <style>
    :root {
      --bg-dark: #0a0a0a;
      --primary: #fa586a;
      --text-main: #ffffff;
      --text-sub: rgba(255, 255, 255, 0.6);
      --anim-ease: cubic-bezier(0.25, 1, 0.5, 1);
      --z-bg: 0;
      --z-app: 10;
      --z-mini-bar: 50;
      --z-modal: 100;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-sub);
      height: 100vh;
      height: 100dvh; /* 移动端关键修复 */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* ===== 背景优化 (减少GPU消耗) ===== */
    .ambient-bg {
      position: absolute;
      inset: 0;
      z-index: var(--z-bg);
      overflow: hidden;
      background: #121212;
    }

    .ambient-bg img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.6;
      transform: scale(1.2);
      filter: blur(60px); /* 降低模糊半径以提升性能 */
      transition: opacity 1s ease;
      will-change: transform, opacity; /* 提示浏览器硬件加速 */
    }

    .ambient-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1;
    }

    /* ===== 布局与组件 ===== */
    .app-layer {
      position: relative;
      z-index: var(--z-app);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .app-header {
      height: 60px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      flex-shrink: 0;
    }

    .logo { color: var(--text-main); font-weight: 800; font-size: 18px; }
    
    .config-select {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: var(--text-main);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
    }

    .app-body {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr;
      overflow: hidden;
    }

    /* 左侧播放器 (Desktop) */
    .player-sidebar {
      padding: 30px;
      background: rgba(0, 0, 0, 0.2);
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .cd-wrapper {
      width: 240px;
      height: 240px;
      margin-bottom: 20px;
      position: relative;
    }

    .cd-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      animation: rotate 20s linear infinite;
      animation-play-state: paused;
      will-change: transform;
    }

    .playing .cd-img { animation-play-state: running; }
    @keyframes rotate { to { transform: rotate(360deg); } }

    .track-info { width: 100%; margin-bottom: 20px; }
    .track-title { color: var(--text-main); font-size: 20px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px;}
    .track-artist { color: var(--primary); font-size: 15px; }

    .controls-desktop { width: 100%; display: flex; flex-direction: column; gap: 15px; }

    /* 优化滑块 */
    .progress-wrap { display: flex; align-items: center; gap: 10px; font-size: 11px; color: var(--text-sub); }
    input[type=range] {
      flex: 1; -webkit-appearance: none; background: transparent; height: 30px; /* 增加点击区域 */ cursor: pointer;
    }
    input[type=range]::-webkit-slider-runnable-track { height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

    .btns-main { display: flex; justify-content: center; gap: 20px; align-items: center; }
    .btn { background: none; border: none; cursor: pointer; color: var(--text-main); padding: 5px; transition: opacity 0.2s; }
    .btn:active { transform: scale(0.9); }
    .btn svg { width: 28px; height: 28px; fill: currentColor; }
    .btn-play-lg { width: 60px; height: 60px; background: #fff; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .btn-play-lg svg { width: 30px; height: 30px; margin-left: 2px; }

    /* 右侧内容区 */
    .content-area { display: flex; flex-direction: column; overflow: hidden; }
    .tabs-nav { display: flex; gap: 20px; padding: 15px 30px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .tab-item { background: none; border: none; color: var(--text-sub); font-size: 15px; font-weight: 600; cursor: pointer; padding: 5px 0; }
    .tab-item.active { color: var(--text-main); border-bottom: 2px solid var(--primary); }

    .view-container { flex: 1; overflow-y: auto; padding: 20px 30px; -webkit-overflow-scrolling: touch; }
    .view-section { display: none; }
    .view-section.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* 列表项优化 */
    .list-row {
      display: flex; align-items: center; padding: 12px; border-radius: 8px; cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.02); transition: background 0.2s;
    }
    .list-row:hover { background: rgba(255,255,255,0.05); }
    .list-row.active { background: rgba(255,255,255,0.1); }
    .list-row.active .song-title { color: var(--primary); }

    /* 优化版声波 (GPU friendly) */
    .visualizer { display: flex; gap: 2px; align-items: flex-end; width: 14px; height: 14px; margin-right: 10px; }
    .visualizer span {
      background: var(--primary); width: 3px; height: 100%; border-radius: 2px;
      transform-origin: bottom; animation: barScale 1s infinite ease-in-out; will-change: transform;
    }
    .visualizer span:nth-child(1) { animation-delay: -0.2s; }
    .visualizer span:nth-child(3) { animation-delay: -0.4s; }
    @keyframes barScale { 0%, 100% { transform: scaleY(0.2); } 50% { transform: scaleY(1); } }

    /* 歌词优化 */
    .lyrics-wrap {
      text-align: center; height: 100%; overflow-y: auto; padding: 40px 0;
      mask-image: linear-gradient(to bottom, transparent, #000 15%, #000 85%, transparent);
      -webkit-mask-image: linear-gradient(to bottom, transparent, #000 15%, #000 85%, transparent);
    }
    .lrc-p { padding: 10px 0; color: rgba(255,255,255,0.3); font-size: 16px; transition: color 0.3s, transform 0.3s; cursor: pointer; }
    .lrc-p.active { color: #fff; font-size: 22px; font-weight: 700; transform: scale(1.05); }

    /* ===== 移动端适配 (重点修复) ===== */
    .mobile-mini-bar { display: none; }
    .mobile-full-player { display: none; }

    @media (max-width: 900px) {
      .app-body { display: block; padding-bottom: 70px; /* 为mini bar留空 */ }
      .player-sidebar { display: none; }
      .app-header { position: sticky; top: 0; z-index: 20; background: rgba(0,0,0,0.8); }
      .view-container { padding: 15px; }
      
      /* Mini Bar 修复 */
      .mobile-mini-bar {
        display: flex; position: fixed; bottom: 0; left: 0; right: 0; height: 64px;
        background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        z-index: var(--z-mini-bar); align-items: center; padding: 0 16px;
        padding-bottom: env(safe-area-inset-bottom);
      }
      .mini-cover { width: 44px; height: 44px; border-radius: 6px; margin-right: 12px; object-fit: cover; }
      .mini-info { flex: 1; overflow: hidden; }
      .mini-title { color: #fff; font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .mini-artist { color: #aaa; font-size: 12px; }
      .mini-btn { padding: 10px; font-size: 20px; background: none; border: none; color: #fff; }

      /* 全屏播放器修复 (使用visibility避免点击穿透) */
      .mobile-full-player {
        display: flex; flex-direction: column; position: fixed; inset: 0; z-index: var(--z-modal);
        background: #121212; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), visibility 0.3s;
        transform: translateY(100%); visibility: hidden;
        padding: 20px; padding-top: max(20px, env(safe-area-inset-top)); padding-bottom: max(30px, env(safe-area-inset-bottom));
      }
      .mobile-full-player.open { transform: translateY(0); visibility: visible; }
      
      .mobile-bg-blur { position: absolute; inset: 0; z-index: -1; overflow: hidden; }
      .mobile-bg-blur img { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: blur(50px); transform: scale(1.1); }

      .player-drag-indicator { width: 40px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 3px; margin: 0 auto 20px; flex-shrink: 0; }

      .mobile-main-view { flex: 1; position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
      
      /* 封面与歌词切换 */
      .mobile-cover-box {
        width: 80vw; height: 80vw; max-width: 320px; max-height: 320px;
        border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        transition: transform 0.4s ease, opacity 0.3s ease; position: absolute;
      }
      .mobile-cover-box img { width: 100%; height: 100%; object-fit: cover; }
      
      .mobile-lyrics-box {
        position: absolute; inset: 0; overflow-y: auto; text-align: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        padding: 20px 0; -webkit-overflow-scrolling: touch;
      }
      
      /* 状态切换 */
      .show-lyrics .mobile-cover-box { opacity: 0; transform: scale(0.9); pointer-events: none; }
      .show-lyrics .mobile-lyrics-box { opacity: 1; pointer-events: auto; }
      .mobile-lrc-line { padding: 12px 10px; color: rgba(255,255,255,0.4); font-size: 16px; min-height: 40px;}
      .mobile-lrc-line.active { color: #fff; font-size: 20px; font-weight: 700; }

      .mobile-controls { width: 100%; margin-top: 20px; flex-shrink: 0; z-index: 2; }
      .mobile-track-info { margin-bottom: 20px; text-align: left; }
      .mobile-btns { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
      .btn-play-m { width: 70px; height: 70px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; }
      .btn-play-m svg { width: 32px; height: 32px; fill: #000; margin-left: 4px; }
      .btn-m { background: none; border: none; color: #fff; padding: 10px; }
      .btn-m svg { width: 32px; height: 32px; fill: #fff; }
    }
  </style>
</head>

<body>

  <div class="ambient-bg"><img id="bg-img" src=""></div>
  <div class="ambient-overlay"></div>

  <div class="app-layer">
    <header class="app-header">
      <div class="logo">Mini Music</div>
      <select id="source-select" class="config-select">
        <option value="qq">QQ 音乐</option>
        <option value="netease">网易云</option>
        <option value="kuwo">酷我</option>
      </select>
    </header>

    <div class="app-body">
      <!-- Desktop Sidebar -->
      <aside class="player-sidebar" id="desktop-player">
        <div class="cd-wrapper"><img id="now-cover" class="cd-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
        <div class="track-info">
          <div id="now-title" class="track-title">Ready</div>
          <div id="now-artist" class="track-artist">Select a song</div>
        </div>
        <div class="controls-desktop">
          <div class="progress-wrap">
            <span id="time-curr">00:00</span>
            <input type="range" id="progress" value="0" min="0" max="100">
            <span id="time-total">00:00</span>
          </div>
          <div class="btns-main">
            <button id="btn-prev" class="btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
            <button id="btn-play" class="btn btn-play-lg"><svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
            <button id="btn-next" class="btn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="content-area">
        <nav class="tabs-nav">
          <button class="tab-item active" onclick="app.switchTab('discover')">发现</button>
          <button class="tab-item" onclick="app.switchTab('playlist')">队列</button>
          <button class="tab-item" onclick="app.switchTab('lyrics')">歌词</button>
        </nav>

        <div class="view-container">
          <div id="tab-discover" class="view-section active">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
              <input id="search-input" class="config-select" style="flex:1; padding:10px 16px; font-size:16px;" placeholder="Search..." />
              <button id="search-btn" class="config-select" style="padding:0 20px;">Go</button>
            </div>
            <div id="toplist-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:15px;"></div>
          </div>

          <div id="tab-playlist" class="view-section">
            <div id="playlist-container"></div>
          </div>

          <div id="tab-lyrics" class="view-section" style="height:100%;">
            <div id="lyrics-box" class="lyrics-wrap"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Mobile Mini Bar -->
  <div class="mobile-mini-bar" id="mini-bar">
    <img id="mini-cover" class="mini-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" />
    <div class="mini-info">
      <div id="mini-title" class="mini-title">Ready</div>
      <div id="mini-artist" class="mini-artist">-</div>
    </div>
    <button id="mini-play-btn" class="mini-btn">▶</button>
  </div>

  <!-- Mobile Full Player -->
  <div class="mobile-full-player" id="full-player">
    <div class="mobile-bg-blur"><img id="mobile-bg-img" src=""></div>
    <div class="player-drag-indicator" onclick="app.toggleFullPlayer(false)"></div>
    
    <div class="mobile-main-view">
      <!-- 封面与歌词区域点击切换 -->
      <div class="mobile-cover-box" id="m-cover-area"><img id="mobile-cover-img" src=""></div>
      <div class="mobile-lyrics-box" id="mobile-lyrics-box"></div>
    </div>

    <div class="mobile-controls">
      <div class="mobile-track-info">
        <div id="mobile-track-title" class="track-title" style="font-size:24px;">Title</div>
        <div id="mobile-track-artist" class="track-artist" style="font-size:16px;">Artist</div>
      </div>
      
      <div class="progress-wrap" style="margin-bottom:20px;">
        <span id="m-time-curr">00:00</span>
        <input type="range" id="m-progress" value="0" min="0" max="100">
        <span id="m-time-total">00:00</span>
      </div>

      <div class="mobile-btns">
        <button id="m-btn-prev" class="btn-m"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button id="m-btn-play" class="btn-m btn-play-m"><svg id="m-icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
        <button id="m-btn-next" class="btn-m"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
      </div>
    </div>
  </div>

  <audio id="audio" playsinline webkit-playsinline crossorigin="anonymous"></audio>

  <script>
    const app = {
      apiBase: "https://music-dl.sayqz.com/api/",
      state: {
        source: "qq",
        playlist: [],
        index: -1,
        lyrics: [],
        lrcIdx: -1,
        isDragging: false // 防止拖动进度条时闪烁
      },
      $: (id) => document.getElementById(id),
      
      init() {
        this.bindEvents();
        this.loadToplists();
      },

      bindEvents() {
        const { $ } = this;
        
        // 播放控制
        const toggle = () => this.togglePlay();
        const prev = () => this.playOffset(-1);
        const next = () => this.playOffset(1);

        $('btn-play').onclick = toggle;
        $('m-btn-play').onclick = toggle;
        $('mini-play-btn').onclick = (e) => { e.stopPropagation(); toggle(); };
        
        $('btn-prev').onclick = $('m-btn-prev').onclick = prev;
        $('btn-next').onclick = $('m-btn-next').onclick = next;

        // 进度条优化：拖动时不频繁更新
        const seek = (e) => {
          const audio = $('audio');
          if(audio.duration) audio.currentTime = (e.target.value / 100) * audio.duration;
          this.state.isDragging = false;
        };
        const dragStart = () => this.state.isDragging = true;

        $('progress').oninput = $('m-progress').oninput = dragStart;
        $('progress').onchange = $('m-progress').onchange = seek;

        // Audio 核心事件
        const audio = $('audio');
        audio.ontimeupdate = () => {
          if(!this.state.isDragging) this.updateProgress();
          this.syncLyrics();
        };
        audio.onended = next;
        audio.onplay = () => this.setUIState(true);
        audio.onpause = () => this.setUIState(false);
        audio.onloadedmetadata = () => {
          const t = this.fmtTime(audio.duration);
          $('time-total').innerText = $('m-time-total').innerText = t;
        }

        // 搜索与配置
        $('search-btn').onclick = () => this.doSearch($('search-input').value);
        $('source-select').onchange = (e) => { this.state.source = e.target.value; this.loadToplists(); };
        
        // 移动端交互
        $('mini-bar').onclick = () => this.toggleFullPlayer(true);
        // 点击封面切换歌词
        const toggleLrc = () => $('full-player').classList.toggle('show-lyrics');
        $('m-cover-area').onclick = toggleLrc;
        $('mobile-lyrics-box').onclick = toggleLrc;
      },

      async fetch(params) {
        const u = new URL(this.apiBase);
        Object.keys(params).forEach(k => u.searchParams.append(k, params[k]));
        try { return await (await fetch(u)).json(); } catch(e) { return null; }
      },

      async loadToplists() {
        const grid = this.$('toplist-grid');
        grid.innerHTML = '<div style="color:#aaa; padding:20px;">Loading...</div>';
        const res = await this.fetch({ type: 'toplists', source: this.state.source });
        grid.innerHTML = '';
        (res?.data?.list || []).slice(0, 16).forEach(t => {
          const div = document.createElement('div');
          div.style.cursor = 'pointer';
          div.innerHTML = `<img src="${t.pic}" style="width:100%; border-radius:12px; aspect-ratio:1; object-fit:cover; background:#333; margin-bottom:8px;">
                           <div style="font-size:12px; font-weight:600; line-height:1.4;">${t.name}</div>`;
          div.onclick = () => this.loadList(t);
          grid.appendChild(div);
        });
      },

      async doSearch(kw) {
        if(!kw) return;
        this.$('search-btn').innerText = "...";
        const res = await this.fetch({ type: 'search', keyword: kw, source: this.state.source });
        this.$('search-btn').innerText = "Go";
        this.updatePlaylist(res?.data?.results || res?.data?.list || []);
      },

      async loadList(top) {
        try {
            // 简单处理，实际API可能需要 ID 再次请求
            // 假设 search 或 detail API 返回 list
            if(top.url) { // 模拟请求榜单详情
               // 实际逻辑根据具体API调整，这里仅作演示
               this.doSearch(top.name); 
            }
        } catch(e) {}
      },

      updatePlaylist(list) {
        this.state.playlist = list;
        this.state.index = -1;
        const box = this.$('playlist-container');
        box.innerHTML = '';
        
        // 使用 DocumentFragment 优化渲染
        const frag = document.createDocumentFragment();
        list.forEach((t, i) => {
          const el = document.createElement('div');
          el.className = 'list-row';
          el.id = `trk-${i}`;
          el.innerHTML = `
            <div id="vis-${i}" style="width:24px;"></div>
            <div style="flex:1; min-width:0;">
                <div class="song-title" style="font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${t.name || t.title}</div>
                <div style="font-size:12px; opacity:0.6;">${t.artist || t.singer || 'Unknown'}</div>
            </div>`;
          el.onclick = () => this.playAt(i);
          frag.appendChild(el);
        });
        box.appendChild(frag);
        this.switchTab('playlist');
      },

      playAt(i) {
        if(!this.state.playlist[i]) return;
        const prev = this.state.index;
        this.state.index = i;
        const song = this.state.playlist[i];
        
        // 更新视觉状态
        if(prev >= 0 && this.$(`vis-${prev}`)) this.$(`vis-${prev}`).innerHTML = '';
        if(this.$(`trk-${prev}`)) this.$(`trk-${prev}`).classList.remove('active');
        
        if(this.$(`vis-${i}`)) this.$(`vis-${i}`).innerHTML = `<div class="visualizer"><span></span><span></span><span></span></div>`;
        if(this.$(`trk-${i}`)) this.$(`trk-${i}`).classList.add('active');

        // 标准化数据
        const meta = {
          id: song.id || song.mid,
          name: song.name || song.title,
          artist: song.artist || song.singer || (song.ar?.[0]?.name),
          pic: song.pic || song.al?.picUrl || "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
          url: song.url,
          lrc: song.lrc
        };

        this.updateMeta(meta);
        this.loadLyrics(meta.lrc);

        // 获取URL并播放
        const play = (url) => {
            this.$('audio').src = url;
            this.$('audio').play().catch(e => console.log('Autoplay blocked'));
        };

        if(meta.url) play(meta.url);
        else this.fetch({ type: 'url', id: meta.id, source: this.state.source }).then(res => play(res?.data || ''));
      },

      updateMeta(m) {
        const { $ } = this;
        $('now-title').innerText = $('mini-title').innerText = $('mobile-track-title').innerText = m.name;
        $('now-artist').innerText = $('mini-artist').innerText = $('mobile-track-artist').innerText = m.artist;
        
        const imgs = ['now-cover', 'mini-cover', 'bg-img', 'mobile-bg-img', 'mobile-cover-img'];
        imgs.forEach(id => $(id).src = m.pic);
        
        if('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: m.name, artist: m.artist, artwork: [{ src: m.pic }]
            });
        }
      },

      togglePlay() {
        const a = this.$('audio');
        a.paused ? a.play() : a.pause();
      },

      setUIState(playing) {
        const icon = playing ? "M6 19h4V5H6v14zm8-14v14h4V5h-4z" : "M8 5v14l11-7z";
        ['icon-play', 'm-icon-play'].forEach(id => this.$(id).querySelector('path').setAttribute('d', icon));
        this.$('mini-play-btn').innerText = playing ? "⏸" : "▶";
        
        const act = playing ? 'add' : 'remove';
        this.$('desktop-player').classList[act]('playing');
        
        // 只有正在播放时才让旋转动画运行，节省性能
        const cd = this.$('now-cover');
        cd.style.animationPlayState = playing ? 'running' : 'paused';
      },

      playOffset(off) {
        let n = this.state.index + off;
        if(n >= this.state.playlist.length) n = 0;
        if(n < 0) n = this.state.playlist.length - 1;
        this.playAt(n);
      },

      updateProgress() {
        const a = this.$('audio');
        if(!a.duration) return;
        const pct = (a.currentTime / a.duration) * 100;
        const t = this.fmtTime(a.currentTime);
        this.$('progress').value = this.$('m-progress').value = pct;
        this.$('time-curr').innerText = this.$('m-time-curr').innerText = t;
      },

      // === 歌词核心优化 ===
      async loadLyrics(url) {
        this.state.lyrics = [];
        this.state.lrcIdx = -1;
        const setTxt = (t) => {
            this.$('lyrics-box').innerHTML = `<div class="lrc-p">${t}</div>`;
            this.$('mobile-lyrics-box').innerHTML = `<div class="mobile-lrc-line">${t}</div>`;
        }
        
        if(!url) return setTxt("纯音乐 / 无歌词");
        setTxt("Loading...");

        try {
            const txt = await (await fetch(url)).text();
            const arr = [];
            txt.split('\n').forEach(line => {
                const m = line.match(/\[(\d{2}):(\d{2})(\.\d{2,3})?\](.*)/);
                if(m) arr.push({ t: parseInt(m[1])*60 + parseInt(m[2]) + (m[3]?parseFloat(m[3]):0), txt: m[4].trim() });
            });
            this.state.lyrics = arr;
            this.renderLyrics();
        } catch(e) { setTxt("歌词加载失败"); }
      },

      renderLyrics() {
        const box = this.$('lyrics-box');
        const mBox = this.$('mobile-lyrics-box');
        box.innerHTML = ''; mBox.innerHTML = '';
        
        const frag1 = document.createDocumentFragment();
        const frag2 = document.createDocumentFragment();
        
        this.state.lyrics.forEach((l, i) => {
            const p = document.createElement('div');
            p.className = 'lrc-p'; p.innerText = l.txt || '...';
            // 使用事件代理，不要给每个p加事件，这里仅演示ID绑定
            p.dataset.idx = i;
            frag1.appendChild(p);
            
            const mp = document.createElement('div');
            mp.className = 'mobile-lrc-line'; mp.innerText = l.txt || '...';
            mp.dataset.idx = i;
            frag2.appendChild(mp);
        });
        
        box.appendChild(frag1);
        mBox.appendChild(frag2);

        // 事件代理点击跳转
        const seekFn = (e) => {
            const idx = e.target.dataset.idx;
            if(idx !== undefined) this.$('audio').currentTime = this.state.lyrics[idx].t;
        };
        box.onclick = seekFn;
        mBox.onclick = seekFn; // 需注意与切换歌词视图的冲突，移动端建议不做点击跳转或单独处理
      },

      syncLyrics() {
        const lrc = this.state.lyrics;
        if(!lrc.length) return;
        
        const ct = this.$('audio').currentTime;
        // 寻找当前行，简单高效的算法
        let idx = lrc.findIndex(l => l.t > ct) - 1;
        if(idx < 0) idx = lrc.length > 0 && lrc[0].t <= ct ? 0 : -1;
        if(idx === -2) idx = lrc.length - 1; // 到了最后

        if(idx !== this.state.lrcIdx && idx >= 0) {
            this.state.lrcIdx = idx;
            
            // 批量更新类名
            const updateUI = (containerId, cls, activeCls) => {
                const container = this.$(containerId);
                const prev = container.querySelector('.' + activeCls);
                if(prev) prev.classList.remove(activeCls);
                
                const curr = container.children[idx];
                if(curr) {
                    curr.classList.add(activeCls);
                    // 仅当行改变时滚动，且使用 smooth: false 或 CSS transition 避免JS线程卡死
                    curr.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };
            
            updateUI('lyrics-box', 'lrc-p', 'active');
            updateUI('mobile-lyrics-box', 'mobile-lrc-line', 'active');
        }
      },

      fmtTime(s) {
        const m = Math.floor(s/60)||0, sec = Math.floor(s%60)||0;
        return `${m}:${sec.toString().padStart(2,'0')}`;
      },
      
      switchTab(t) {
        document.querySelectorAll('.tab-item').forEach(b => b.classList.toggle('active', b.innerText === (t==='discover'?'发现':t==='playlist'?'队列':'歌词')));
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        this.$(`tab-${t}`).classList.add('active');
      },

      toggleFullPlayer(open) {
        const p = this.$('full-player');
        if(open) {
          p.classList.add('open');
          document.body.style.overflow = 'hidden';
        } else {
          p.classList.remove('open');
          p.classList.remove('show-lyrics'); // Reset
          document.body.style.overflow = '';
        }
      }
    };

    window.onload = () => app.init();
  </script>
</body>
</html>

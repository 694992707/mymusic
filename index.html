<script>
// JavaScript 代码，已针对移动端播放策略进行优化
const API_BASE = "https://music-dl.sayqz.com/api/";

const state = {
  source: "qq",
  searchMode: "search",
  searchResults: [],
  toplists: [],
  currentPlaylist: [],
  currentPlaylistName: "",
  currentIndex: -1,
  isPlaying: false,
  lyricsCache: new Map(),
  isAudioUnlocked: false, // 新增状态，标记音频是否被用户手势解锁
};

const dom = {};

function $(id) {
  return document.getElementById(id);
}

document.addEventListener("DOMContentLoaded", () => {
  // DOM 缓存
  Object.assign(dom, {
    sourceSelect: $("source-select"),
    searchMode: $("search-mode"),
    searchInput: $("search-input"),
    searchBtn: $("search-btn"),
    searchResults: $("search-results"),
    toplistContainer: $("toplist-container"),
    toplistSubtitle: $("toplist-subtitle"),
    audio: $("audio"),
    nowCover: $("now-cover"),
    nowTitle: $("now-title"),
    nowArtist: $("now-artist"),
    nowAlbum: $("now-album"),
    nowStatus: $("now-status"),
    btnPrev: $("btn-prev"),
    btnPlay: $("btn-play"),
    btnNext: $("btn-next"),
    progress: $("progress"),
    timeLabel: $("time-label"),
    durationLabel: $("duration-label"),
    volume: $("volume"),
    lyrics: $("lyrics"),
    lyricsStatus: $("lyrics-status"),
    currentPlaylist: $("current-playlist"),
    playlistInfo: $("playlist-info"),
    playIcon: $("play-icon"),
    pauseIcon: $("pause-icon"),
  });

  // 事件绑定
  dom.sourceSelect.addEventListener("change", () => {
    state.source = dom.sourceSelect.value;
    loadToplists();
  });
  dom.searchMode.addEventListener("change", () => {
    state.searchMode = dom.searchMode.value;
  });
  dom.searchBtn.addEventListener("click", () => {
    const kw = dom.searchInput.value.trim();
    if (kw) doSearch(kw);
  });
  dom.searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const kw = dom.searchInput.value.trim();
      if (kw) doSearch(kw);
    }
  });

  dom.btnPlay.addEventListener("click", togglePlayPause);
  dom.btnPrev.addEventListener("click", () => playOffset(-1));
  dom.btnNext.addEventListener("click", () => playOffset(1));

  dom.progress.addEventListener("input", onSeek);
  dom.volume.addEventListener("input", () => {
    dom.audio.volume = parseFloat(dom.volume.value);
  });

  // audio 事件
  dom.audio.addEventListener("timeupdate", onTimeUpdate);
  dom.audio.addEventListener("loadedmetadata", onLoadedMetadata);
  dom.audio.addEventListener("ended", () => playOffset(1));
  dom.audio.addEventListener("play", () => {
    state.isPlaying = true;
    updatePlayButton();
    if (state.currentIndex > -1) dom.nowStatus.textContent = "播放中";
  });
  dom.audio.addEventListener("pause", () => {
    state.isPlaying = false;
    updatePlayButton();
    if (state.currentIndex > -1) dom.nowStatus.textContent = "已暂停";
  });

  dom.audio.volume = parseFloat(dom.volume.value);

  loadToplists();
});

async function fetchJSON(url) {
  const resp = await fetch(url);
  if (!resp.ok) throw new Error("请求失败: " + resp.status);
  return resp.json();
}

function normalizeTrackList(data) {
  if (!data) return [];
  if (Array.isArray(data)) return data;
  if (Array.isArray(data.tracks)) return data.tracks;
  if (Array.isArray(data.songs)) return data.songs;
  if (Array.isArray(data.list)) return data.list;
  if (Array.isArray(data.results)) return data.results;
  return [];
}

async function doSearch(keyword) {
  try {
    dom.searchBtn.disabled = true;
    dom.searchBtn.textContent = "搜索中...";
    dom.searchResults.innerHTML = "";
    const params = new URLSearchParams({ type: state.searchMode, keyword, limit: "30", page: "1" });
    if (state.searchMode === "search") params.set("source", state.source);
    const url = API_BASE + "?" + params.toString();
    const json = await fetchJSON(url);
    const data = json.data || {};
    state.searchResults = normalizeTrackList(data.results || data) || [];
    renderSearchResults();
  } catch (err) {
    console.error(err);
    dom.searchResults.innerHTML = `<div class="list-item"><div class="list-main"><div class="list-title">搜索失败</div><div class="list-sub">${err.message || "未知错误"}</div></div></div>`;
  } finally {
    dom.searchBtn.disabled = false;
    dom.searchBtn.textContent = "搜索";
  }
}

function renderSearchResults() {
  if (!state.searchResults.length) {
    dom.searchResults.innerHTML = `<div class="list-item"><div class="list-main"><div class="list-title">没有找到结果</div><div class="list-sub">尝试换个关键词～</div></div></div>`;
    return;
  }
  dom.searchResults.innerHTML = state.searchResults.map((track, index) => {
    const trackInfo = normalizeTrack(track);
    return `
    <div class="list-item" data-index="${index}">
      <div class="list-main">
        <div class="list-title">${trackInfo.name}</div>
        <div class="list-sub">${trackInfo.artist} · ${trackInfo.album}</div>
      </div>
      <div class="list-actions">
        <button class="btn-play-track">播放</button>
        <button class="btn-add-track">加入歌单</button>
        <span class="tag">${trackInfo.platform}</span>
      </div>
    </div>`;
  }).join('');

  dom.searchResults.querySelectorAll('.list-item').forEach((item) => {
    const index = parseInt(item.dataset.index, 10);
    const track = state.searchResults[index];
    item.querySelector('.btn-play-track').addEventListener('click', (e) => {
        e.stopPropagation();
        setCurrentPlaylist([track], "单曲播放");
        playAt(0);
    });
    item.querySelector('.btn-add-track').addEventListener('click', (e) => {
        e.stopPropagation();
        addToCurrentPlaylist(track);
    });
    item.addEventListener('click', () => {
        setCurrentPlaylist(state.searchResults, `搜索结果：${dom.searchInput.value || ""}`);
        playAt(index);
    });
  });
}

async function loadToplists() {
  try {
    dom.toplistContainer.innerHTML = "";
    dom.toplistSubtitle.textContent = "加载中...";
    const params = new URLSearchParams({ source: state.source, type: 'toplists' });
    const url = API_BASE + "?" + params.toString();
    const json = await fetchJSON(url);
    const data = json.data || {};
    state.toplists = data.list || [];
    dom.toplistSubtitle.textContent = `来自 ${data.source || state.source} 的官方榜单`;
    renderToplists();
  } catch (err) {
    console.error(err);
    dom.toplistSubtitle.textContent = `加载失败：${err.message || "未知错误"}`;
  }
}

function renderToplists() {
  if (!state.toplists.length) {
    dom.toplistContainer.innerHTML = `<div style="font-size:12px;color:#9ca3af;">当前平台暂时没有返回榜单。</div>`;
    return;
  }
  dom.toplistContainer.innerHTML = state.toplists.slice(0, 30).map(top => `
    <div class="toplist-card" data-url="${top.url}" data-name="${top.name}">
      <img class="toplist-cover" src="${top.pic || ''}" alt="${top.name || '榜单封面'}" loading="lazy">
      <div class="toplist-name">${top.name || '未知榜单'}</div>
      <div class="toplist-meta">${top.updateFrequency || ' '}</div>
    </div>`).join('');

  dom.toplistContainer.querySelectorAll('.toplist-card').forEach(card => {
    card.addEventListener('click', () => loadToplistAsPlaylist({ url: card.dataset.url, name: card.dataset.name }));
  });
}

async function loadToplistAsPlaylist(top) {
  if (!top || !top.url) return;
  try {
    dom.playlistInfo.textContent = "歌单加载中...";
    const json = await fetchJSON(top.url);
    const tracks = normalizeTrackList(json.data);
    if (!tracks.length) {
      dom.playlistInfo.textContent = "该榜单暂无可播放歌曲";
      return;
    }
    setCurrentPlaylist(tracks, top.name || "榜单歌单");
    playAt(0);
  } catch (err) {
    console.error(err);
    dom.playlistInfo.textContent = `加载榜单失败：${err.message || "未知错误"}`;
  }
}

function setCurrentPlaylist(list, name) {
  state.currentPlaylist = (list || []).slice();
  state.currentPlaylistName = name || "";
  state.currentIndex = state.currentPlaylist.length ? 0 : -1;
  renderCurrentPlaylist();
}

function addToCurrentPlaylist(track) {
  if (!track) return;
  if (!state.currentPlaylist.length) {
    setCurrentPlaylist([track], "临时歌单");
    playAt(0);
    return;
  }
  const key = track.id + "#" + (track.platform || state.source);
  const exists = state.currentPlaylist.some(t => (t.id + "#" + (t.platform || state.source)) === key);
  if (!exists) {
    state.currentPlaylist.push(track);
    renderCurrentPlaylist();
  }
}

function renderCurrentPlaylist() {
  if (!state.currentPlaylist.length) {
    dom.currentPlaylist.innerHTML = `<div class="list-item"><div class="list-main"><div class="list-title">暂无歌单</div><div class="list-sub">从左侧搜索结果或推荐歌单加载</div></div></div>`;
    dom.playlistInfo.textContent = "暂无歌单";
    return;
  }
  dom.playlistInfo.textContent = `${state.currentPlaylistName || "当前歌单"} · ${state.currentPlaylist.length} 首`;

  dom.currentPlaylist.innerHTML = state.currentPlaylist.map((track, index) => {
    const trackInfo = normalizeTrack(track);
    const isActive = index === state.currentIndex;
    return `
    <div class="list-item ${isActive ? 'active' : ''}" data-index="${index}">
      <div class="list-main">
        <div class="list-title">${index + 1}. ${trackInfo.name}</div>
        <div class="list-sub">${trackInfo.artist} · ${trackInfo.album}</div>
      </div>
    </div>`;
  }).join('');

  dom.currentPlaylist.querySelectorAll('.list-item').forEach(item => {
    item.addEventListener('click', () => playAt(parseInt(item.dataset.index, 10)));
  });

  const activeItem = dom.currentPlaylist.querySelector('.list-item.active');
  if (activeItem) {
    activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function playAt(index) {
  if (index < 0 || index >= state.currentPlaylist.length) return;
  state.currentIndex = index;
  const track = state.currentPlaylist[index];
  startPlay(track);
  renderCurrentPlaylist();
}

function playOffset(offset) {
  if (!state.currentPlaylist.length || state.currentIndex < 0) return;
  let next = state.currentIndex + offset;
  if (next < 0) next = state.currentPlaylist.length - 1;
  if (next >= state.currentPlaylist.length) next = 0;
  playAt(next);
}

function togglePlayPause() {
  if (!state.currentPlaylist.length || state.currentIndex < 0) {
    if (state.currentPlaylist.length) playAt(0);
    return;
  }
  dom.audio.paused ? dom.audio.play() : dom.audio.pause();
}

function updatePlayButton() {
  const isPlaying = !dom.audio.paused;
  dom.playIcon.style.display = isPlaying ? 'none' : 'inline-block';
  dom.pauseIcon.style.display = isPlaying ? 'inline-block' : 'none';
}

// *** 关键修改：优化 startPlay 函数 ***
function startPlay(rawTrack) {
  const track = normalizeTrack(rawTrack);
  if (!track || !track.url) {
    dom.nowStatus.textContent = "无法播放：缺少音频 URL";
    return;
  }
  
  let playUrl = track.url;
  if (!/[\?&]br=/.test(playUrl) && /[\?&]type=url/.test(playUrl)) {
    playUrl += (playUrl.includes("?") ? "&" : "?") + "br=320k";
  }
  
  dom.audio.src = playUrl;
  
  // play() 方法返回一个 Promise
  const playPromise = dom.audio.play();

  if (playPromise !== undefined) {
    playPromise.then(_ => {
      // 播放成功
      state.isAudioUnlocked = true; // 标记音频已解锁
      dom.nowStatus.textContent = "播放中";
    }).catch(error => {
      // 播放失败，很可能是因为自动播放策略
      console.error("Audio play failed:", error);
      state.isPlaying = false;
      updatePlayButton();
      
      if (error.name === 'NotAllowedError') {
        dom.nowStatus.textContent = "浏览器限制，请点此播放";
        // 引导用户再次点击，此时点击播放按钮将直接触发 play()
      } else {
        dom.nowStatus.textContent = `播放失败: ${error.message}`;
      }
    });
  }

  // 立即更新UI，给用户即时反馈
  dom.nowCover.src = track.pic || "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
  dom.nowTitle.textContent = track.name;
  document.title = `${track.name} - ${track.artist}`;
  dom.nowArtist.textContent = track.artist;
  dom.nowAlbum.textContent = track.album;
  dom.nowStatus.textContent = "连接音频中..."; // 初始状态
  dom.timeLabel.textContent = "00:00";
  dom.durationLabel.textContent = "00:00";
  dom.progress.value = 0;
  
  loadLyricsForTrack(track);
  updateMediaSession(track);
}


function normalizeTrack(t) {
  if (!t) return {};
  return {
    id: t.id || t.songid || t.mid || "",
    name: t.name || t.songname || t.title || "未知歌曲",
    artist: t.artist || t.singer || (t.ar && t.ar[0] && t.ar[0].name) || "未知歌手",
    album: t.album || (t.al && t.al.name) || "未知专辑",
    url: t.url || "",
    pic: t.pic || (t.al && t.al.picUrl) || "",
    lrc: t.lrc || "",
    platform: t.platform || state.source,
  };
}

function updateMediaSession(track) {
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: track.name,
      artist: track.artist,
      album: track.album,
      artwork: [{ src: track.pic || '', sizes: '512x512', type: 'image/jpeg' }]
    });

    navigator.mediaSession.setActionHandler('play', () => togglePlayPause());
    navigator.mediaSession.setActionHandler('pause', () => togglePlayPause());
    navigator.mediaSession.setActionHandler('previoustrack', () => playOffset(-1));
    navigator.mediaSession.setActionHandler('nexttrack', () => playOffset(1));
  }
}

function onTimeUpdate() {
  const { currentTime = 0, duration = 0 } = dom.audio;
  if (!isNaN(duration) && duration > 0) {
    dom.progress.value = (currentTime / duration) * 100;
    dom.timeLabel.textContent = formatTime(currentTime);
  }
}

function onLoadedMetadata() {
  dom.durationLabel.textContent = formatTime(dom.audio.duration);
}

function onSeek() {
  if (isNaN(dom.audio.duration)) return;
  dom.audio.currentTime = (parseFloat(dom.progress.value) / 100) * dom.audio.duration;
}

function formatTime(sec) {
  sec = Math.floor(sec || 0);
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${m}:${s}`;
}

async function loadLyricsForTrack(track) {
  dom.lyrics.textContent = "";
  dom.lyricsStatus.textContent = "加载中...";
  const cacheKey = `${track.platform}#${track.id}`;
  if (state.lyricsCache.has(cacheKey)) {
    dom.lyrics.textContent = state.lyricsCache.get(cacheKey);
    dom.lyricsStatus.textContent = "已缓存";
    return;
  }
  if (!track.lrc) {
    dom.lyricsStatus.textContent = "无歌词接口";
    dom.lyrics.textContent = "当前歌曲没有提供歌词地址。";
    return;
  }
  try {
    const resp = await fetch(track.lrc);
    if (!resp.ok) throw new Error(`歌词请求失败：${resp.status}`);
    const text = await resp.text();
    const cleaned = text.split(/\r?\n/).map(line => line.replace(/\[\d{2}:\d{2}\.\d{2,3}\]/g, '').trim()).filter(Boolean).join("\n");
    const finalText = cleaned || "没有可用的歌词内容。";
    state.lyricsCache.set(cacheKey, finalText);
    dom.lyrics.textContent = finalText;
    dom.lyricsStatus.textContent = "已加载";
  } catch (err) {
    console.error(err);
    dom.lyricsStatus.textContent = "歌词加载失败";
    dom.lyrics.textContent = `歌词加载失败：${err.message || "未知错误"}`;
  }
}
</script>

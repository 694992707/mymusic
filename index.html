<!DOCTYPE html> 
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Mini Music - Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <style>
    :root {
      --bg-dark: #0f172a;
      --glass-surface: rgba(30, 41, 59, 0.75);
      --glass-border: rgba(255, 255, 255, 0.08);
      --primary: #818cf8;
      --active-text: #ffffff;
      --inactive-text: #94a3b8;
      --radius-xl: 24px;
      --radius-md: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg-dark);
      color: var(--inactive-text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* 防止整页滚动，内容区域独立滚动 */
      /* 背景氛围灯 */
      background-image: 
        radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.15), transparent 40%),
        radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.1), transparent 40%);
    }

    /* ===== 顶部导航 ===== */
    .app-header {
      flex-shrink: 0;
      height: 60px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      z-index: 50;
    }
    .logo { font-weight: 700; color: var(--active-text); font-size: 18px; display: flex; gap: 8px; align-items: center; }
    .config-select {
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--active-text);
      padding: 4px 12px;
      border-radius: 99px;
      font-size: 12px;
      outline: none;
    }

    /* ===== 主布局 ===== */
    .app-body {
      flex: 1;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 0;
      overflow: hidden;
    }

    /* --- 左侧：播放器固定区 --- */
    .player-sidebar {
      background: rgba(15, 23, 42, 0.3);
      border-right: 1px solid var(--glass-border);
      padding: 30px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      z-index: 20;
    }

    .cover-box {
      width: 260px;
      height: 260px;
      position: relative;
      border-radius: var(--radius-xl);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .cover-img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-xl); }
    
    .track-meta { text-align: center; width: 100%; }
    .track-title { color: var(--active-text); font-size: 20px; font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-artist { font-size: 14px; color: var(--primary); }

    .control-panel { width: 100%; display: flex; flex-direction: column; gap: 16px; }
    
    .progress-bar { width: 100%; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 10px; font-variant-numeric: tabular-nums; }
    input[type=range] {
      flex: 1; height: 4px; border-radius: 2px; -webkit-appearance: none; background: rgba(255,255,255,0.1);
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 10px; height: 10px; background: #fff; border-radius: 50%; margin-top: -3px;
    }

    .buttons-row { display: flex; justify-content: center; align-items: center; gap: 32px; }
    .btn-icon { background: none; border: none; cursor: pointer; color: var(--active-text); transition: transform 0.1s; display: flex; }
    .btn-icon:active { transform: scale(0.9); }
    .btn-icon svg { width: 28px; height: 28px; fill: currentColor; }
    .btn-play { width: 64px; height: 64px; background: var(--active-text); border-radius: 50%; color: #000; display: grid; place-items: center; box-shadow: 0 10px 25px rgba(255,255,255,0.2); }
    .btn-play svg { width: 24px; height: 24px; }

    /* --- 右侧：内容交互区 (Tab System) --- */
    .content-area {
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .tabs-header {
      display: flex;
      gap: 24px;
      padding: 20px 30px;
      border-bottom: 1px solid var(--glass-border);
    }
    .tab-btn {
      background: none;
      border: none;
      font-size: 15px;
      font-weight: 600;
      color: var(--inactive-text);
      cursor: pointer;
      position: relative;
      padding: 8px 0;
      transition: color 0.2s;
    }
    .tab-btn.active { color: var(--active-text); }
    .tab-btn.active::after {
      content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 3px;
    }

    .tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px 30px;
      display: none; /* 默认隐藏 */
      scroll-behavior: smooth;
    }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Tab 1: 发现 (搜索 + 榜单) */
    .search-wrap { display: flex; gap: 10px; margin-bottom: 30px; }
    .search-input { 
      flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); 
      color: #fff; padding: 12px 20px; border-radius: var(--radius-md); font-size: 16px; outline: none;
    }
    .btn-primary { background: var(--primary); border: none; color: #fff; padding: 0 24px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; }

    .section-title { font-size: 18px; color: var(--active-text); margin-bottom: 16px; font-weight: 600; }
    
    .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 16px; }
    .card-item { cursor: pointer; transition: transform 0.2s; }
    .card-item:hover { transform: translateY(-4px); }
    .card-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: var(--radius-md); margin-bottom: 8px; background: #222; }
    .card-text { font-size: 13px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* Tab 2: 歌词 (Lyrics) */
    .lyrics-container {
      height: 100%;
      text-align: center;
      /* 模拟 Apple Music 歌词效果 */
      mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
      overflow-y: auto;
      padding: 100px 0; /* 留白给 mask */
    }
    .lrc-line {
      min-height: 40px;
      padding: 12px 20px;
      font-size: 16px;
      color: rgba(255,255,255,0.4);
      transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      cursor: pointer;
    }
    .lrc-line:hover { background: rgba(255,255,255,0.05); }
    .lrc-line.active {
      color: #fff;
      font-size: 22px;
      font-weight: 700;
      text-shadow: 0 0 20px rgba(255,255,255,0.3);
      transform: scale(1.05);
    }

    /* Tab 3: 队列 (Queue / Search Result) */
    .song-list { display: flex; flex-direction: column; }
    .song-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-radius: 8px; cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .song-row:hover { background: rgba(255,255,255,0.05); }
    .song-row.active { background: rgba(129, 140, 248, 0.15); border-left: 3px solid var(--primary); }
    .song-main { flex: 1; overflow: hidden; }
    .song-title { color: var(--active-text); font-size: 15px; margin-bottom: 4px; }
    .song-sub { font-size: 12px; }

    /* ===== 移动端适配 ===== */
    @media (max-width: 900px) {
      body { height: auto; overflow: auto; display: block; padding-bottom: 120px; }
      .app-header { position: sticky; top: 0; background: rgba(15,23,42,0.9); }
      .app-body { display: block; }
      
      /* 移动端播放器改为顶部卡片 */
      .player-sidebar {
        padding: 20px;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        border-right: none;
        border-bottom: 1px solid var(--glass-border);
      }
      .cover-box { width: 80px; height: 80px; border-radius: 8px; flex-shrink: 0; box-shadow: none; }
      .track-meta { text-align: left; }
      .control-panel { display: none; /* 移动端顶部不显示进度条和完整按钮，只显示基本信息 */ }
      
      /* 移动端底部悬浮条 */
      .mobile-controls {
        display: flex; position: fixed; bottom: 0; left: 0; right: 0;
        background: rgba(30,41,59,0.95); backdrop-filter: blur(20px);
        padding: 12px 20px; border-top: 1px solid var(--glass-border);
        align-items: center; justify-content: space-between; z-index: 100;
        padding-bottom: max(12px, env(safe-area-inset-bottom));
      }
      .tabs-header { position: sticky; top: 60px; background: var(--bg-dark); z-index: 40; padding: 10px 20px; }
      .tab-content { padding: 20px; height: auto; overflow: visible; }
      
      /* 移动端歌词高度限制 */
      .lyrics-container { height: 400px; mask-image: none; -webkit-mask-image: none; }
      .lrc-line.active { font-size: 18px; transform: scale(1); color: var(--primary); }
    }
    
    @media (min-width: 901px) {
      .mobile-controls { display: none; }
    }
  </style>
</head>
<body>

<header class="app-header">
  <div class="logo">
    <span style="color:var(--primary)">♪</span> Mini Music Pro
  </div>
  <div style="display:flex; gap:10px;">
    <select id="source-select" class="config-select">
      <option value="qq">QQ 音乐</option>
      <option value="netease">网易云</option>
      <option value="kuwo">酷我</option>
    </select>
  </div>
</header>

<div class="app-body">
  
  <!-- 左侧固定播放器 (桌面端) / 顶部信息 (移动端) -->
  <aside class="player-sidebar">
    <div class="cover-box">
      <img id="now-cover" class="cover-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Cover">
    </div>
    <div class="track-meta">
      <div id="now-title" class="track-title">等待播放</div>
      <div id="now-artist" class="track-artist">Mini Music Player</div>
    </div>

    <!-- 桌面端控制器 -->
    <div class="control-panel">
      <div class="progress-bar">
        <span id="time-curr">00:00</span>
        <input type="range" id="progress" value="0" min="0" max="100">
        <span id="time-total">00:00</span>
      </div>
      <div class="buttons-row">
        <button id="btn-prev" class="btn-icon"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button id="btn-play" class="btn-icon btn-play"><svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
        <button id="btn-next" class="btn-icon"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
      </div>
      <div style="display:flex; align-items:center; gap:8px;">
        <svg style="width:16px; opacity:0.5; fill:#fff" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>
        <input type="range" id="volume" min="0" max="1" step="0.05" value="0.8">
      </div>
    </div>
  </aside>

  <!-- 右侧 Tab 内容区 -->
  <main class="content-area">
    <div class="tabs-header">
      <button class="tab-btn active" onclick="switchTab('discover')">发现</button>
      <button class="tab-btn" onclick="switchTab('playlist')">队列</button>
      <button class="tab-btn" onclick="switchTab('lyrics')">歌词</button>
    </div>

    <!-- Tab 1: 发现 -->
    <div id="tab-discover" class="tab-content active">
      <div class="search-wrap">
        <input id="search-input" class="search-input" placeholder="搜索 歌曲 / 歌手 / 专辑..." />
        <button id="search-btn" class="btn-primary">搜索</button>
      </div>

      <div class="section-title">热门榜单</div>
      <div id="toplist-grid" class="grid-cards">
        <!-- JS 填充 -->
        <div style="color:#666; font-size:12px;">正在获取榜单数据...</div>
      </div>
    </div>

    <!-- Tab 2: 播放队列 & 搜索结果 -->
    <div id="tab-playlist" class="tab-content">
      <div class="section-title">当前列表 / 结果 <span id="list-count" style="font-size:12px; opacity:0.5; margin-left:10px;">0 首</span></div>
      <div id="playlist-container" class="song-list">
        <div style="text-align:center; padding:40px; color:#555;">暂无歌曲，请去“发现”页搜索或点选榜单</div>
      </div>
    </div>

    <!-- Tab 3: 歌词 -->
    <div id="tab-lyrics" class="tab-content" style="padding:0;">
      <div id="lyrics-box" class="lyrics-container">
        <div class="lrc-line">Mini Music Player</div>
        <div class="lrc-line">歌词将在这里显示</div>
      </div>
    </div>
  </main>
</div>

<!-- 移动端底部控制栏 -->
<div class="mobile-controls">
  <div style="flex:1;">
    <div id="mob-title" style="color:#fff; font-weight:600; font-size:14px;">等待播放</div>
    <div id="mob-artist" style="color:#999; font-size:12px;">...</div>
  </div>
  <button id="mob-play" style="background:none; border:none; color:#fff; font-size:24px;">▶</button>
</div>

<audio id="audio" playsinline webkit-playsinline crossorigin="anonymous"></audio>

<script>
  const API_BASE = "https://music-dl.sayqz.com/api/";
  
  // 状态管理
  const state = {
    source: "qq",
    playlist: [],
    currentIndex: -1,
    isPlaying: false,
    lyricsData: [], // [{time: 12.5, text: "Ahhh"}]
    currentLrcIndex: -1
  };

  // DOM 缓存
  const $ = (id) => document.getElementById(id);
  const els = {};

  function initDOM() {
    ['source-select', 'search-input', 'search-btn', 'toplist-grid', 
     'playlist-container', 'list-count', 'lyrics-box', 'audio',
     'now-cover', 'now-title', 'now-artist', 'time-curr', 'time-total', 
     'progress', 'btn-prev', 'btn-play', 'btn-next', 'icon-play', 'volume',
     'mob-title', 'mob-artist', 'mob-play'
    ].forEach(id => els[id] = $(id));
  }

  // --- UI Logic: Tabs ---
  window.switchTab = function(tabName) {
    // 切换按钮状态
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.toggle('active', btn.innerText === (tabName === 'discover' ? '发现' : tabName === 'playlist' ? '队列' : '歌词'));
    });
    // 切换内容显隐
    document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
    $(`tab-${tabName}`).classList.add('active');
    
    // 如果切到歌词，尝试滚动到高亮处
    if(tabName === 'lyrics') scrollLyricsToCenter();
  };

  document.addEventListener("DOMContentLoaded", () => {
    initDOM();
    
    // Event Listeners
    els['source-select'].addEventListener('change', () => {
      state.source = els['source-select'].value;
      loadToplists();
    });

    els['search-btn'].addEventListener('click', () => doSearch(els['search-input'].value));
    els['search-input'].addEventListener('keydown', e => e.key === 'Enter' && doSearch(els['search-input'].value));

    // Controls
    const toggle = () => togglePlay();
    els['btn-play'].addEventListener('click', toggle);
    els['mob-play'].addEventListener('click', toggle);
    els['btn-prev'].addEventListener('click', () => playOffset(-1));
    els['btn-next'].addEventListener('click', () => playOffset(1));
    
    // Audio Events
    els.audio.addEventListener('timeupdate', () => {
      updateProgress();
      syncLyrics();
    });
    els.audio.addEventListener('ended', () => playOffset(1));
    els.audio.addEventListener('loadedmetadata', () => {
      els['time-total'].textContent = formatTime(els.audio.duration);
    });
    els.audio.addEventListener('error', (e) => {
      console.error(e);
      els['now-artist'].textContent = "播放出错/资源受限";
    });

    // Seek
    els.progress.addEventListener('input', (e) => {
      const duration = els.audio.duration || 0;
      els.audio.currentTime = (e.target.value / 100) * duration;
    });
    els.volume.addEventListener('input', (e) => els.audio.volume = e.target.value);

    // Initial Load
    loadToplists();
  });

  // --- Core Music Logic ---

  async function fetchAPI(params) {
    const u = new URL(API_BASE);
    Object.keys(params).forEach(key => u.searchParams.append(key, params[key]));
    try {
      const res = await fetch(u);
      return await res.json();
    } catch(e) {
      console.error(e);
      return null;
    }
  }

  function normalizeList(data) {
    if(!data) return [];
    return data.data?.list || data.data?.results || data.data || [];
  }

  // 搜索
  async function doSearch(keyword) {
    if(!keyword.trim()) return;
    els['search-btn'].textContent = "...";
    const res = await fetchAPI({ type: 'search', keyword, source: state.source });
    const list = normalizeList(res);
    state.playlist = list;
    state.currentIndex = -1;
    renderPlaylist(list);
    switchTab('playlist');
    els['search-btn'].textContent = "搜索";
  }

  // 榜单
  async function loadToplists() {
    els['toplist-grid'].innerHTML = '<div style="color:#666">加载中...</div>';
    const res = await fetchAPI({ type: 'toplists', source: state.source });
    const list = normalizeList(res);
    
    els['toplist-grid'].innerHTML = '';
    list.slice(0, 15).forEach(top => {
      const div = document.createElement('div');
      div.className = 'card-item';
      div.innerHTML = `
        <img class="card-img" src="${top.pic}" loading="lazy">
        <div class="card-text">${top.name}</div>
      `;
      div.onclick = () => loadToplistDetail(top);
      els['toplist-grid'].appendChild(div);
    });
  }

  async function loadToplistDetail(top) {
    // API 实际上很多时候返回的 toplist 对象里没有直接的 id，需要 fetch url
    // 这里简化处理，假设 click 后直接解析 url
    if(!top.url) return;
    els['list-count'].textContent = "加载榜单中...";
    try {
      const res = await fetch(top.url).then(r => r.json());
      const songs = normalizeList(res);
      state.playlist = songs;
      state.currentIndex = -1;
      renderPlaylist(songs);
      switchTab('playlist');
    } catch(e) { alert("榜单加载失败，可能是跨域限制"); }
  }

  function renderPlaylist(list) {
    els['list-count'].textContent = `${list.length} 首`;
    els['playlist-container'].innerHTML = '';
    list.forEach((t, i) => {
      const row = document.createElement('div');
      row.className = 'song-row';
      if(i === state.currentIndex) row.classList.add('active');
      row.innerHTML = `
        <div class="song-main">
          <div class="song-title">${t.name || t.title}</div>
          <div class="song-sub">${t.artist || t.singer || 'Unknown'}</div>
        </div>
      `;
      row.onclick = () => playAt(i);
      els['playlist-container'].appendChild(row);
    });
  }

  // --- Playback ---

  function playAt(index) {
    if(!state.playlist[index]) return;
    state.currentIndex = index;
    const track = state.playlist[index];
    
    // Normalize Track Data
    const song = {
      id: track.id || track.mid,
      name: track.name || track.title,
      artist: track.artist || track.singer || (track.ar?.[0]?.name),
      pic: track.pic || track.al?.picUrl || "https://via.placeholder.com/200?text=Music",
      url: track.url,
      lrc: track.lrc,
      platform: track.platform || state.source
    };

    // UI Updates
    els['now-cover'].src = song.pic;
    els['now-title'].textContent = song.name;
    els['now-artist'].textContent = song.artist;
    els['mob-title'].textContent = song.name;
    els['mob-artist'].textContent = song.artist;
    
    // Highlight in list
    document.querySelectorAll('.song-row').forEach((row, i) => {
      row.classList.toggle('active', i === index);
    });

    // Get URL
    if(song.url) {
      els.audio.src = song.url;
      startAudio(song);
    } else {
      // Fetch URL dynamically
      fetchAPI({ type: 'url', id: song.id, source: song.platform })
        .then(res => {
          if(res.data) els.audio.src = res.data;
          else els.audio.src = ""; // Error
          startAudio(song);
        });
    }

    // Lyrics
    loadLyrics(song);
  }

  function startAudio(song) {
    els.audio.play().then(() => {
      state.isPlaying = true;
      updateBtnState();
      // !!! 核心修正 2：设置 Media Session (iOS 控制台支持) !!!
      updateMediaSession(song);
    }).catch(e => {
      console.warn("Autoplay blocked or error", e);
      state.isPlaying = false;
      updateBtnState();
    });
  }

  function togglePlay() {
    if(els.audio.paused) {
      els.audio.play();
      state.isPlaying = true;
    } else {
      els.audio.pause();
      state.isPlaying = false;
    }
    updateBtnState();
  }

  function playOffset(off) {
    let next = state.currentIndex + off;
    if(next >= state.playlist.length) next = 0;
    if(next < 0) next = state.playlist.length - 1;
    playAt(next);
  }

  function updateBtnState() {
    const d = state.isPlaying ? "M6 19h4V5H6v14zm8-14v14h4V5h-4z" : "M8 5v14l11-7z";
    els['icon-play'].querySelector('path').setAttribute('d', d);
    els['mob-play'].textContent = state.isPlaying ? "⏸" : "▶";
  }

  function updateProgress() {
    const cur = els.audio.currentTime;
    const dur = els.audio.duration;
    if(dur) {
      els['time-curr'].textContent = formatTime(cur);
      els['progress'].value = (cur / dur) * 100;
    }
  }

  function formatTime(s) {
    const m = Math.floor(s/60) || 0;
    const sc = Math.floor(s%60) || 0;
    return `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
  }

  // --- 核心修正 1：歌词解析与同步 (Lyrics Parser & Sync) ---
  
  async function loadLyrics(song) {
    state.lyricsData = [];
    els['lyrics-box'].innerHTML = '<div class="lrc-line">加载歌词...</div>';
    
    let lrcText = "";
    if(song.lrc && song.lrc.startsWith('http')) {
      try {
        const res = await fetch(song.lrc);
        lrcText = await res.text();
      } catch(e) {
        lrcText = "[00:00.00] 无法加载歌词 (CORS)";
      }
    } else {
      lrcText = "[00:00.00] 暂无歌词";
    }

    // Parse LRC
    const lines = lrcText.split('\n');
    const parsed = [];
    const reg = /\[(\d{2}):(\d{2})(\.\d{2,3})?\](.*)/;
    
    lines.forEach(line => {
      const match = line.match(reg);
      if(match) {
        const min = parseInt(match[1]);
        const sec = parseInt(match[2]);
        const ms = match[3] ? parseFloat(match[3]) : 0;
        const text = match[4].trim();
        if(text) {
          parsed.push({ time: min*60 + sec + ms, text: text });
        }
      }
    });
    
    state.lyricsData = parsed;
    renderLyricsUI();
  }

  function renderLyricsUI() {
    els['lyrics-box'].innerHTML = '';
    if(!state.lyricsData.length) {
      els['lyrics-box'].innerHTML = '<div class="lrc-line">纯音乐 / 无歌词</div>';
      return;
    }
    const frag = document.createDocumentFragment();
    state.lyricsData.forEach((line, i) => {
      const div = document.createElement('div');
      div.className = 'lrc-line';
      div.textContent = line.text;
      div.dataset.index = i;
      div.onclick = () => {
        els.audio.currentTime = line.time;
      };
      frag.appendChild(div);
    });
    els['lyrics-box'].appendChild(frag);
  }

  function syncLyrics() {
    if(!state.lyricsData.length) return;
    const cur = els.audio.currentTime;
    
    // Find active line
    let activeIdx = state.lyricsData.findIndex(l => l.time > cur) - 1;
    if(activeIdx < 0) activeIdx = state.lyricsData.length - 1; 
    // Fix: if cur < first line, findIndex is 0, -1 is -1. Use 0 if we passed nothing yet? 
    // Actually findIndex returns index of first element satisfying. if time > cur is line 0 (cur=0), then -1.
    // Let's optimize:
    for(let i=0; i<state.lyricsData.length; i++) {
        if(state.lyricsData[i].time > cur) {
            activeIdx = i - 1;
            break;
        }
    }
    if(activeIdx < 0) activeIdx = 0;

    if(activeIdx !== state.currentLrcIndex) {
      state.currentLrcIndex = activeIdx;
      
      const lines = document.querySelectorAll('.lrc-line');
      lines.forEach(l => l.classList.remove('active'));
      if(lines[activeIdx]) {
        lines[activeIdx].classList.add('active');
        scrollLyricsToCenter();
      }
    }
  }

  function scrollLyricsToCenter() {
    const active = document.querySelector('.lrc-line.active');
    const container = els['lyrics-box'];
    if(active && container) {
      // 居中计算：子元素顶部偏移 - 容器一半高度 + 子元素一半高度
      const top = active.offsetTop - container.clientHeight / 2 + active.clientHeight / 2;
      container.scrollTo({ top: top, behavior: 'smooth' });
    }
  }

  // --- 核心修正 2：Media Session API (iOS/Android 锁屏控制) ---
  
  function updateMediaSession(song) {
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: song.name,
        artist: song.artist,
        artwork: [
          { src: song.pic, sizes: '96x96',   type: 'image/png' },
          { src: song.pic, sizes: '128x128', type: 'image/png' },
          { src: song.pic, sizes: '192x192', type: 'image/png' },
          { src: song.pic, sizes: '512x512', type: 'image/png' },
        ]
      });

      // 绑定动作
      navigator.mediaSession.setActionHandler('play', () => {
        els.audio.play();
        state.isPlaying = true; 
        updateBtnState();
      });
      navigator.mediaSession.setActionHandler('pause', () => {
        els.audio.pause();
        state.isPlaying = false; 
        updateBtnState();
      });
      navigator.mediaSession.setActionHandler('previoustrack', () => playOffset(-1));
      navigator.mediaSession.setActionHandler('nexttrack', () => playOffset(1));
      
      // 进度拖拽支持
      navigator.mediaSession.setActionHandler('seekto', (details) => {
        if (details.seekTime || details.seekTime === 0) {
          els.audio.currentTime = details.seekTime;
        }
      });
    }
  }

</script>
</body>
</html>

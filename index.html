<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>Mini QQ Music - Modern Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
/* --- 全局与重置 --- */
:root {
  --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --bg-color: #0c0a09;
  --panel-bg: rgba(23, 23, 23, 0.6);
  --panel-border: rgba(255, 255, 255, 0.1);
  --text-primary: #f5f5f5;
  --text-secondary: #a3a3a3;
  --text-muted: #737373;
  --accent-color: #3b82f6;
  --accent-hover: #60a5fa;
  --hover-bg: rgba(255, 255, 255, 0.07);
  --active-bg: rgba(0, 0, 0, 0.2);
  --border-radius-md: 12px;
  --border-radius-lg: 16px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  scrollbar-width: thin;
  scrollbar-color: var(--text-muted) transparent;
}

::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
::-webkit-scrollbar-thumb {
  background: var(--text-muted);
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
  background: var(--text-secondary);
}

body {
  font-family: var(--font-sans);
  background-color: var(--bg-color);
  background-image:
    radial-gradient(circle at 15% 50%, rgba(59, 130, 246, 0.2), transparent 40%),
    radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.15), transparent 40%);
  color: var(--text-primary);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* --- 头部 --- */
header {
  padding: 14px 24px;
  backdrop-filter: blur(12px);
  background: rgba(12, 10, 9, 0.7);
  border-bottom: 1px solid var(--panel-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
header .title {
  font-size: 20px;
  font-weight: 600;
}
header .title span {
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: 10px;
  font-weight: 400;
}
header .controls {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 13px;
}

/* --- 表单控件 --- */
select, input, button {
  background: rgba(38, 38, 38, 0.8);
  border: 1px solid var(--panel-border);
  color: var(--text-primary);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 13px;
  outline: none;
  transition: all 0.2s ease;
}
select:focus, input:focus {
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
}
button {
  cursor: pointer;
}
button:hover {
  background: var(--hover-bg);
  border-color: var(--accent-hover);
}
button:active {
  transform: scale(0.96);
  background: var(--active-bg);
}
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* --- 主体布局 --- */
main {
  flex: 1;
  display: grid;
  grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.4fr);
  gap: 18px;
  padding: 18px;
  min-height: 0;
}

.panel {
  background: var(--panel-bg);
  border-radius: var(--border-radius-lg);
  border: 1px solid var(--panel-border);
  backdrop-filter: blur(20px);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  min-height: 0;
  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}

.panel-title {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.panel-title small {
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 400;
}

/* --- 左侧面板 --- */
.search-bar {
  display: flex;
  gap: 10px;
}
.search-bar input {
  flex: 1;
}
.search-bar button {
  flex-shrink: 0;
}

.list {
  border-radius: var(--border-radius-md);
  border: 1px solid var(--panel-border);
  background: rgba(0,0,0,0.1);
  overflow: auto;
  min-height: 0;
}
.list-item {
  padding: 10px 14px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}
.list-item:last-child {
  border-bottom: none;
}
.list-item:hover {
  background: var(--hover-bg);
}
.list-main {
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 0;
  flex: 1;
}
.list-title {
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 500;
}
.list-sub {
  font-size: 12px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.list-actions {
  display: flex;
  flex-shrink: 0;
  gap: 8px;
  align-items: center;
}
.list-actions button {
  padding: 5px 10px;
  font-size: 12px;
}
.tag {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid var(--text-muted);
  color: var(--text-secondary);
  background: rgba(255,255,255,0.05);
}

.toplist-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 12px;
  overflow: auto;
}
.toplist-card {
  background: rgba(0,0,0,0.15);
  border-radius: var(--border-radius-md);
  border: 1px solid var(--panel-border);
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.toplist-card:hover {
  background: var(--hover-bg);
  border-color: var(--accent-hover);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.toplist-cover {
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 8px;
  object-fit: cover;
  background: #1c1917;
}
.toplist-name {
  font-size: 13px;
  line-height: 1.4;
  font-weight: 500;
  max-height: 2.8em;
  overflow: hidden;
}
.toplist-meta {
  font-size: 11px;
  color: var(--text-muted);
}

/* --- 右侧面板 (播放器核心) --- */
.now-playing {
  display: flex;
  gap: 16px;
}
.now-cover {
  width: 120px;
  height: 120px;
  border-radius: var(--border-radius-md);
  background: #1c1917;
  border: 1px solid var(--panel-border);
  object-fit: cover;
  flex-shrink: 0;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  transition: all 0.3s ease;
}
.now-cover:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}
.now-meta {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
  justify-content: center;
}
.now-title {
  font-size: 18px;
  font-weight: 600;
}
.now-artist {
  font-size: 14px;
  color: var(--text-secondary);
}
.now-album {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

.player-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: auto;
}
.player-controls button {
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 999px;
  border: 1px solid var(--panel-border);
  background: transparent;
  width: 38px;
  height: 38px;
  padding: 0;
}
.player-controls button.main {
  width: 50px;
  height: 50px;
  background: var(--accent-color);
  border: none;
}
.player-controls button.main:hover {
  background: var(--accent-hover);
}
.player-controls button svg {
  width: 20px;
  height: 20px;
  fill: var(--text-primary);
}
.player-controls button.main svg {
  width: 24px;
  height: 24px;
}


.slider-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 6px;
}
input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 5px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 5px;
  outline: none;
  cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 14px;
  height: 14px;
  background: var(--text-primary);
  border-radius: 50%;
  border: none;
  transition: background 0.2s ease;
}
input[type="range"]::-moz-range-thumb {
  width: 14px;
  height: 14px;
  background: var(--text-primary);
  border-radius: 50%;
  border: none;
  transition: background 0.2s ease;
}
input[type="range"]:hover::-webkit-slider-thumb {
  background: var(--accent-hover);
}
input[type="range"]:hover::-moz-range-thumb {
  background: var(--accent-hover);
}
.slider-row .label {
  font-size: 11px;
  color: var(--text-secondary);
  width: 40px;
  text-align: center;
}

.lyrics {
  margin-top: 10px;
  border-radius: var(--border-radius-md);
  border: 1px solid var(--panel-border);
  background: rgba(0,0,0,0.1);
  padding: 12px;
  height: 140px;
  overflow: auto;
  font-size: 13px;
  line-height: 1.7;
  white-space: pre-wrap;
  color: var(--text-secondary);
}

.current-playlist-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 13px;
  margin-bottom: 4px;
}
.current-playlist-header small {
  color: var(--text-muted);
  font-size: 11px;
}

.current-playlist-list .list-item.active {
  background: var(--accent-color);
  color: white;
}
.current-playlist-list .list-item.active .list-sub {
  color: rgba(255,255,255,0.8);
}

/* --- 页脚 --- */
footer {
  padding: 8px 24px 10px;
  font-size: 11px;
  color: var(--text-muted);
  border-top: 1px solid var(--panel-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
footer a {
  color: var(--accent-hover);
  text-decoration: none;
}
footer a:hover {
  text-decoration: underline;
}

/* --- 响应式 --- */
@media (max-width: 900px) {
  main {
    grid-template-columns: 1fr;
    height: auto;
    overflow: auto;
  }
  .now-playing {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .now-cover {
    width: 60%;
    max-width: 200px;
    height: auto;
  }
  .now-meta {
    width: 100%;
  }
}
</style>
</head>
<body>

<header>
  <div class="title">
    Mini QQ Music
    <span>本地单文件播放器 · 基于 TuneHub API</span>
  </div>
  <div class="controls">
    <label>
      平台：
      <select id="source-select">
        <option value="qq">QQ 音乐</option>
        <option value="netease">网易云</option>
        <option value="kuwo">酷我</option>
      </select>
    </label>
    <label>
      模式：
      <select id="search-mode">
        <option value="search">当前平台</option>
        <option value="aggregateSearch">聚合搜索</option>
      </select>
    </label>
  </div>
</header>

<main>
  <!-- 左侧：搜索 + 推荐歌单 -->
  <section class="panel">
    <div class="panel-title">
      <span>歌曲搜索</span>
      <small>支持歌名 / 歌手 / 专辑</small>
    </div>
    <div class="search-bar">
      <input id="search-input" placeholder="输入关键词，例如：周杰伦" />
      <button id="search-btn">搜索</button>
    </div>
    <div id="search-results" class="list" aria-label="搜索结果"></div>
    <div class="panel-title" style="margin-top:10px;">
      <span>推荐歌单 / 榜单</span>
      <small id="toplist-subtitle">基于所选平台的官方榜单</small>
    </div>
    <div id="toplist-container" class="toplist-grid"></div>
  </section>

  <!-- 右侧：正在播放 + 当前歌单 -->
  <section class="panel">
    <div class="panel-title">
      <span>正在播放</span>
      <small id="now-status">空闲</small>
    </div>
    <div class="now-playing">
      <img id="now-cover" class="now-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="封面" />
      <div class="now-meta">
        <div id="now-title" class="now-title">尚未播放歌曲</div>
        <div id="now-artist" class="now-artist">选择一首歌或歌单开始播放</div>
        <div id="now-album" class="now-album"></div>
        <div class="player-controls">
          <button id="btn-prev" title="上一首">
             <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg>
          </button>
          <button id="btn-play" class="main" title="播放/暂停">
            <!-- Play Icon -->
            <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
            <!-- Pause Icon (hidden by default) -->
            <svg id="pause-icon" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
          </button>
          <button id="btn-next" title="下一首">
            <svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2zm-4.5 6l-8.5 6V6z"></path></svg>
          </button>
        </div>
        <div class="slider-row">
          <span class="label" id="time-label">00:00</span>
          <input type="range" id="progress" min="0" max="100" value="0" title="进度"/>
          <span class="label" id="duration-label">00:00</span>
        </div>
        <div class="slider-row">
          <span class="label">音量</span>
          <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8" title="音量"/>
        </div>
      </div>
    </div>
    <div class="panel-title" style="margin-top:8px;">
      <span>歌词</span>
      <small id="lyrics-status"></small>
    </div>
    <div id="lyrics" class="lyrics"></div>
    <div class="current-playlist-header" style="margin-top:10px;">
      <span>当前歌单</span>
      <small id="playlist-info">暂无歌单</small>
    </div>
    <div id="current-playlist" class="list current-playlist-list"></div>
  </section>
</main>

<footer>
  <span>仅供学习交流，音频内容均来自各音乐平台，请勿商用。</span>
  <span>API：<a href="https://music-dl.sayqz.com/" target="_blank" rel="noreferrer">TuneHub</a></span>
</footer>

<audio id="audio" crossorigin="anonymous"></audio>

<script>
// JavaScript 代码与原版完全相同，以确保功能不变
const API_BASE = "https://music-dl.sayqz.com/api/";

const state = {
source: "qq",
searchMode: "search",
searchResults: [],
toplists: [],
currentPlaylist: [],
currentPlaylistName: "",
currentIndex: -1,
isPlaying: false,
lyricsCache: new Map(),
};

const dom = {};

function $(id) {
return document.getElementById(id);
}

document.addEventListener("DOMContentLoaded", () => {
// DOM 缓存
Object.assign(dom, {
sourceSelect: $("source-select"),
searchMode: $("search-mode"),
searchInput: $("search-input"),
searchBtn: $("search-btn"),
searchResults: $("search-results"),
toplistContainer: $("toplist-container"),
toplistSubtitle: $("toplist-subtitle"),
audio: $("audio"),
nowCover: $("now-cover"),
nowTitle: $("now-title"),
nowArtist: $("now-artist"),
nowAlbum: $("now-album"),
nowStatus: $("now-status"),
btnPrev: $("btn-prev"),
btnPlay: $("btn-play"),
btnNext: $("btn-next"),
progress: $("progress"),
timeLabel: $("time-label"),
durationLabel: $("duration-label"),
volume: $("volume"),
lyrics: $("lyrics"),
lyricsStatus: $("lyrics-status"),
currentPlaylist: $("current-playlist"),
playlistInfo: $("playlist-info"),
playIcon: $("play-icon"),
pauseIcon: $("pause-icon"),
});

// 事件绑定
dom.sourceSelect.addEventListener("change", () => {
state.source = dom.sourceSelect.value;
loadToplists();
});
dom.searchMode.addEventListener("change", () => {
state.searchMode = dom.searchMode.value;
});
dom.searchBtn.addEventListener("click", () => {
const kw = dom.searchInput.value.trim();
if (kw) doSearch(kw);
});
dom.searchInput.addEventListener("keydown", (e) => {
if (e.key === "Enter") {
const kw = dom.searchInput.value.trim();
if (kw) doSearch(kw);
}
});

dom.btnPlay.addEventListener("click", togglePlayPause);
dom.btnPrev.addEventListener("click", () => playOffset(-1));
dom.btnNext.addEventListener("click", () => playOffset(1));

dom.progress.addEventListener("input", onSeek);
dom.volume.addEventListener("input", () => {
dom.audio.volume = parseFloat(dom.volume.value);
});

// audio 事件
dom.audio.addEventListener("timeupdate", onTimeUpdate);
dom.audio.addEventListener("loadedmetadata", onLoadedMetadata);
dom.audio.addEventListener("ended", () => playOffset(1));
dom.audio.addEventListener("play", () => {
  state.isPlaying = true;
  updatePlayButton();
  if (state.currentIndex > -1) dom.nowStatus.textContent = "播放中";
});
dom.audio.addEventListener("pause", () => {
  state.isPlaying = false;
  updatePlayButton();
  if (state.currentIndex > -1) dom.nowStatus.textContent = "已暂停";
});


dom.audio.volume = parseFloat(dom.volume.value);

// 初始加载榜单
loadToplists();
});

// 通用请求
async function fetchJSON(url) {
const resp = await fetch(url);
if (!resp.ok) throw new Error("请求失败: " + resp.status);
return resp.json();
}

function normalizeTrackList(data) {
if (!data) return [];
if (Array.isArray(data)) return data;
if (Array.isArray(data.tracks)) return data.tracks;
if (Array.isArray(data.songs)) return data.songs;
if (Array.isArray(data.list)) return data.list;
if (Array.isArray(data.results)) return data.results;
return [];
}

// 搜索
async function doSearch(keyword) {
try {
dom.searchBtn.disabled = true;
dom.searchBtn.textContent = "搜索中...";
dom.searchResults.innerHTML = "";

const params = new URLSearchParams();
params.set("type", state.searchMode);
params.set("keyword", keyword);
params.set("limit", "30");
params.set("page", "1");

if (state.searchMode === "search") {
params.set("source", state.source);
}

const url = API_BASE + "?" + params.toString();
const json = await fetchJSON(url);

const data = json.data || {};
const results = normalizeTrackList(data.results || data);

state.searchResults = results || [];
renderSearchResults();
} catch (err) {
console.error(err);
dom.searchResults.innerHTML =
'<div class="list-item"><div class="list-main"><div class="list-title">搜索失败</div><div class="list-sub">' +
(err.message || "未知错误") +
"</div></div></div>";
} finally {
dom.searchBtn.disabled = false;
dom.searchBtn.textContent = "搜索";
}
}

function renderSearchResults() {
const list = state.searchResults;
if (!list.length) {
dom.searchResults.innerHTML =
'<div class="list-item"><div class="list-main"><div class="list-title">没有找到结果</div><div class="list-sub">尝试换个关键词～</div></div></div>';
return;
}

dom.searchResults.innerHTML = "";
list.forEach((track, index) => {
const item = document.createElement("div");
item.className = "list-item";

const main = document.createElement("div");
main.className = "list-main";
const title = document.createElement("div");
title.className = "list-title";
title.textContent = track.name || "未知歌曲";
const sub = document.createElement("div");
sub.className = "list-sub";
sub.textContent =
(track.artist || track.ar || track.singer || "未知歌手") +
" · " +
(track.album || track.al || "未知专辑");
main.appendChild(title);
main.appendChild(sub);

const actions = document.createElement("div");
actions.className = "list-actions";

const btnPlay = document.createElement("button");
btnPlay.textContent = "播放";
btnPlay.addEventListener("click", (e) => {
e.stopPropagation();
setCurrentPlaylist([track], "单曲播放");
playAt(0);
});

const btnAdd = document.createElement("button");
btnAdd.textContent = "加入歌单";
btnAdd.addEventListener("click", (e) => {
e.stopPropagation();
addToCurrentPlaylist(track);
});

const tag = document.createElement("span");
tag.className = "tag";
tag.textContent = track.platform || state.source;

actions.appendChild(btnPlay);
actions.appendChild(btnAdd);
actions.appendChild(tag);

item.appendChild(main);
item.appendChild(actions);

item.addEventListener("click", () => {
// 点击整行：替换当前歌单并播放
setCurrentPlaylist(list, "搜索结果：" + (dom.searchInput.value || ""));
playAt(index);
});

dom.searchResults.appendChild(item);
});
}

// 推荐榜单
async function loadToplists() {
try {
dom.toplistContainer.innerHTML = "";
dom.toplistSubtitle.textContent = "加载中...";
const params = new URLSearchParams();
params.set("source", state.source);
params.set("type", "toplists");
const url = API_BASE + "?" + params.toString();
const json = await fetchJSON(url);
const data = json.data || {};
const list = data.list || [];

state.toplists = list;
dom.toplistSubtitle.textContent =
"来自 " + (data.source || state.source) + " 的官方榜单";
renderToplists();
} catch (err) {
console.error(err);
dom.toplistSubtitle.textContent = "加载失败：" + (err.message || "未知错误");
dom.toplistContainer.innerHTML =
'<div style="font-size:12px;color:#9ca3af;">无法加载榜单，稍后再试或更换平台。</div>';
}
}

function renderToplists() {
const list = state.toplists || [];
if (!list.length) {
dom.toplistContainer.innerHTML =
'<div style="font-size:12px;color:#9ca3af;">当前平台暂时没有返回榜单。</div>';
return;
}
dom.toplistContainer.innerHTML = "";

list.slice(0, 30).forEach((top) => {
const card = document.createElement("div");
card.className = "toplist-card";

const img = document.createElement("img");
img.className = "toplist-cover";
img.src = top.pic || "";
img.alt = top.name || "榜单封面";

const name = document.createElement("div");
name.className = "toplist-name";
name.textContent = top.name || "未知榜单";

const meta = document.createElement("div");
meta.className = "toplist-meta";
meta.textContent = top.updateFrequency || " ";

card.appendChild(img);
card.appendChild(name);
card.appendChild(meta);

card.addEventListener("click", () => loadToplistAsPlaylist(top));

dom.toplistContainer.appendChild(card);
});
}

async function loadToplistAsPlaylist(top) {
if (!top || !top.url) return;
try {
dom.playlistInfo.textContent = "歌单加载中...";
const json = await fetchJSON(top.url);
const tracks = normalizeTrackList(json.data);

if (!tracks.length) {
dom.playlistInfo.textContent = "该榜单暂无可播放歌曲";
return;
}

setCurrentPlaylist(tracks, top.name || "榜单歌单");
playAt(0);
} catch (err) {
console.error(err);
dom.playlistInfo.textContent = "加载榜单失败：" + (err.message || "未知错误");
}
}

// 当前歌单管理
function setCurrentPlaylist(list, name) {
state.currentPlaylist = (list || []).slice();
state.currentPlaylistName = name || "";
state.currentIndex = state.currentPlaylist.length ? 0 : -1;
renderCurrentPlaylist();
}

function addToCurrentPlaylist(track) {
if (!track) return;
if (!state.currentPlaylist.length) {
setCurrentPlaylist([track], "临时歌单");
playAt(0);
return;
}
// 简单去重：按 id + 平台
const key = track.id + "#" + (track.platform || state.source);
const exists = state.currentPlaylist.some(
(t) => t.id + "#" + (t.platform || state.source) === key
);
if (!exists) {
state.currentPlaylist.push(track);
renderCurrentPlaylist();
}
}

function renderCurrentPlaylist() {
const list = state.currentPlaylist || [];
if (!list.length) {
dom.currentPlaylist.innerHTML =
'<div class="list-item"><div class="list-main"><div class="list-title">暂无歌单</div><div class="list-sub">从左侧搜索结果或推荐歌单加载</div></div></div>';
dom.playlistInfo.textContent = "暂无歌单";
return;
}
dom.playlistInfo.textContent =
(state.currentPlaylistName || "当前歌单") +
" · " +
list.length +
" 首";

dom.currentPlaylist.innerHTML = "";
list.forEach((track, index) => {
const item = document.createElement("div");
item.className = "list-item";
if (index === state.currentIndex) {
item.classList.add("active");
// 滚动到视图
item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

const main = document.createElement("div");
main.className = "list-main";
const title = document.createElement("div");
title.className = "list-title";
title.textContent =
(index + 1) + ". " + (track.name || "未知歌曲");
const sub = document.createElement("div");
sub.className = "list-sub";
sub.textContent =
(track.artist || "未知歌手") +
" · " +
(track.album || "未知专辑");
main.appendChild(title);
main.appendChild(sub);

const actions = document.createElement("div");
actions.className = "list-actions";

const btnPlay = document.createElement("button");
btnPlay.textContent = "播放";
btnPlay.addEventListener("click", (e) => {
e.stopPropagation();
playAt(index);
});
actions.appendChild(btnPlay);

item.appendChild(main);
item.appendChild(actions);

item.addEventListener("click", () => playAt(index));

dom.currentPlaylist.appendChild(item);
});
}

// 播放控制
function playAt(index) {
if (!state.currentPlaylist.length) return;
if (index < 0 || index >= state.currentPlaylist.length) return;
state.currentIndex = index;
const track = state.currentPlaylist[index];
startPlay(track);
renderCurrentPlaylist();
}

function playOffset(offset) {
if (!state.currentPlaylist.length) return;
if (state.currentIndex < 0) return;
let next = state.currentIndex + offset;
if (next < 0) next = state.currentPlaylist.length - 1;
if (next >= state.currentPlaylist.length) next = 0;
playAt(next);
}

function togglePlayPause() {
if (!state.currentPlaylist.length || state.currentIndex < 0) {
  if (state.currentPlaylist.length) playAt(0);
  return;
}
if (dom.audio.paused) {
  dom.audio.play();
} else {
  dom.audio.pause();
}
}

function updatePlayButton() {
if (state.isPlaying) {
  dom.playIcon.style.display = 'none';
  dom.pauseIcon.style.display = 'inline-block';
} else {
  dom.playIcon.style.display = 'inline-block';
  dom.pauseIcon.style.display = 'none';
}
}

function startPlay(rawTrack) {
const track = normalizeTrack(rawTrack);
if (!track || !track.url) {
dom.nowStatus.textContent = "无法播放：缺少音频 URL";
return;
}

let playUrl = track.url;
if (!/[\?&]br=/.test(playUrl) && /[\?&]type=url/.test(playUrl)) {
const sep = playUrl.includes("?") ? "&" : "?";
playUrl = playUrl + sep + "br=320k";
}

dom.audio.src = playUrl;
dom.audio.play().catch((e) => {
console.error(e);
dom.nowStatus.textContent = "播放失败：" + (e.message || "未知错误");
});

// 更新 UI
dom.nowCover.src = track.pic || "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
dom.nowTitle.textContent = track.name || "未知歌曲";
document.title = `${track.name || "歌曲"} - ${track.artist || "歌手"}`;
dom.nowArtist.textContent = track.artist || "未知歌手";
dom.nowAlbum.textContent = track.album || "";
dom.nowStatus.textContent = "连接音频中...";
dom.timeLabel.textContent = "00:00";
dom.durationLabel.textContent = "00:00";
dom.progress.value = 0;

loadLyricsForTrack(track);
}

function normalizeTrack(t) {
if (!t) return null;
return {
id: t.id || t.songid || t.mid || "",
name: t.name || t.songname || t.title || "",
artist: t.artist || t.singer || (t.ar && t.ar[0] && t.ar[0].name) || "",
album: t.album || (t.al && t.al.name) || "",
url: t.url || "",
pic: t.pic || (t.al && t.al.picUrl) || "",
lrc: t.lrc || "",
platform: t.platform || state.source,
};
}

// 进度和时间
function onTimeUpdate() {
const cur = dom.audio.currentTime || 0;
const dur = dom.audio.duration || 0;
if (!isNaN(cur) && !isNaN(dur) && dur > 0) {
dom.progress.value = (cur / dur) * 100;
dom.timeLabel.textContent = formatTime(cur);
}
}

function onLoadedMetadata() {
const dur = dom.audio.duration || 0;
dom.durationLabel.textContent = formatTime(dur);
}

function onSeek() {
const dur = dom.audio.duration || 0;
if (!dur || isNaN(dur)) return;
const pct = parseFloat(dom.progress.value) / 100;
dom.audio.currentTime = dur * pct;
}

function formatTime(sec) {
sec = Math.floor(sec || 0);
const m = String(Math.floor(sec / 60)).padStart(2, "0");
const s = String(sec % 60).padStart(2, "0");
return m + ":" + s;
}

// 歌词
async function loadLyricsForTrack(track) {
dom.lyrics.textContent = "";
dom.lyricsStatus.textContent = "加载中...";
const cacheKey = track.platform + "#" + track.id;
if (state.lyricsCache.has(cacheKey)) {
dom.lyrics.textContent = state.lyricsCache.get(cacheKey);
dom.lyricsStatus.textContent = "已缓存";
return;
}

if (!track.lrc) {
dom.lyricsStatus.textContent = "无歌词接口";
dom.lyrics.textContent = "当前歌曲没有提供歌词地址。";
return;
}

try {
const resp = await fetch(track.lrc);
if (!resp.ok) throw new Error("歌词请求失败：" + resp.status);
const text = await resp.text();

const lines = text.split(/\r?\n/);
const cleaned = lines
.map(line => line.replace(/\[\d{2}:\d{2}\.\d{2,3}\]/g, '').trim())
.filter(line => line)
.join("\n");

const finalText = cleaned || "没有可用的歌词内容。";
state.lyricsCache.set(cacheKey, finalText);
dom.lyrics.textContent = finalText;
dom.lyricsStatus.textContent = "已加载";
} catch (err) {
console.error(err);
dom.lyricsStatus.textContent = "歌词加载失败";
dom.lyrics.textContent =
"歌词加载失败：" + (err.message || "未知错误");
}
}
</script>
</body>
</html>
